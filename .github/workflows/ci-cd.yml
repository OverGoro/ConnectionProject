name: Java CI/CD Pipeline

on:
  push:
    branches: [ main]
  pull_request:
    branches: [ main]
env:
  JAVA_VERSION: '21'
  GRADLE_VERSION: '8.7'
  POSTGRES_IMAGE: 'postgres:15'
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build and Test
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5434:5432
    permissions: # –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫
        contents: read # –î–ª—è checkout –∫–æ–¥–∞
        actions: read # (–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏) –î–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –¥—Ä—É–≥–∏–º–∏ Actions
        packages: read # (–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏) –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å GitHub Packages
    steps:
      - name: Install Allure CLI
        run: |
          sudo apt-get update
          sudo apt-get install allure
      - name: Setup Allure TestOps
        # You may pin to the exact commit or the version.
        # uses: allure-framework/setup-allurectl@a06d172c13fb9f51145d605e5178f7a84e502d5f
        uses: allure-framework/setup-allurectl@v1.0.2
          
          
      - name: Setup Java JDK
        uses: actions/setup-java@v5.0.0
        with:
          # The Java version to set up. Takes a whole or semver Java version. See examples of supported syntax in README file
          java-version: '21'
          distribution: 'adopt'          
    
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'
          
      - name: Create Gradle Wrapper
        run: |
          echo "üîß Creating Gradle Wrapper..."
          cd code && gradle wrapper
          chmod +x gradlew
          echo "‚úÖ Gradle Wrapper creation completed"        
          
      - name: üèóÔ∏è Build modules
        run: |
          echo "üöÄ Building and publishing shared modules to Maven Local..."
          if [ -f "code/gradlew" ]; then
            cd code && ./gradlew build -x test -x copyJarToK8s
          else
            echo "‚ùå Cannot build - gradlew not found"
            exit 1
          fi    
          
      - name: üß™ Run All Tests
        run: |
          echo "üß™ Running all tests with testAll task..."
          if [ -f "code/gradlew" ]; then
            cd code && ./gradlew test --continue
          else
            echo "‚ùå Cannot run tests - gradlew not found"
            exit 1
          fi
          
        continue-on-error: true
      - name: Cache
        uses: actions/cache@v4.3.0
        with:
          # A list of files, directories, and wildcard patterns to cache and restore
          path: |
            **/.gradle
            **/gradle
            **/build
          # An explicit key for restoring and saving the cache
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle- 
          save-always: true
          continue-on-error: true
          
      - name: üìä Generate Test Reports
        if: always()
        run: |
          echo "üìä Generating test reports..."
          if [ -f "code/gradlew" ]; then
            cd code && ./gradlew generateCombinedAllureReport
          else
            echo "‚ùå Cannot generate reports - gradlew not found"
          fi
      - name: Upload Allure report  # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –≤ GitHub Actions
        if: always()  # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —É—Å–ø–µ—Ö–∞/–Ω–µ—É—Å–ø–µ—Ö–∞ —Ç–µ—Å—Ç–æ–≤
        uses: actions/upload-artifact@v4
        with:
          name: allure-report  # –ù–∞–∑–≤–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
          path: code/build/reports/allure-report  # –ü—É—Ç—å –∫ —Ñ–∞–π–ª–∞–º –æ—Ç—á–µ—Ç–∞
  publish-report:  # –î–∂–æ–±–∞ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ Allure-–æ—Ç—á–µ—Ç–∞ –Ω–∞ GitHub Pages
    if: always()  # –î–∂–æ–±–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Å–ø–µ—Ö–∞ –∏–ª–∏ –Ω–µ—É—Å–ø–µ—Ö–∞ run-tests
    needs: [ build-and-test ]  # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è run-tests
    runs-on: ubuntu-latest  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é Ubuntu

    steps:
      - name: Check out repository  # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, –≤–∫–ª—é—á–∞—è –≤–µ—Ç–∫—É gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages  # –û–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥–µ–º –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤ –≤–µ—Ç–∫–µ gh-pages
          path: gh-pages  # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫—É gh-pages

      - name: Download Allure results  # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
        uses: actions/download-artifact@v4
        with:
          name: allure-report  # –ù–∞–∑–≤–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
          path: code/build/reports/allure-report  # –ü—É—Ç—å –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

      - name: Allure Report action from marketplace  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ Allure
        uses: simple-elf/allure-report-action@v1.12
        if: always()
        with:
          allure_results: allure-results  # –ü–∞–ø–∫–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–æ–≤
          allure_history: allure-history  # –ü–∞–ø–∫–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç—á–µ—Ç–æ–≤

      - name: Deploy report to Github Pages  # –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –Ω–∞ GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}  # –¢–æ–∫–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é
          publish_branch: gh-pages  # –ü—É–±–ª–∏–∫—É–µ–º –æ—Ç—á–µ—Ç –≤ –≤–µ—Ç–∫—É gh-pages
          publish_dir: allure-history  # –ü–∞–ø–∫–∞, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
