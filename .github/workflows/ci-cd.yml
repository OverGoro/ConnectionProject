name: Java CI/CD Pipeline

on:
  push:
    branches: [ main]
  pull_request:
    branches: [ main]
env:
  JAVA_VERSION: '21'
  GRADLE_VERSION: '8.7'
  POSTGRES_IMAGE: 'postgres:15'
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build and Test
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5434:5432
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ—ï¸ Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'gradle'
        
    - name: ğŸ”§ Create Gradle Wrapper
      run: |
        echo "ğŸ”§ Creating Gradle Wrapper..."
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
        echo "ğŸ“ Project structure:"
        ls -la code/
        
        # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² ĞºĞ¾Ñ€Ğ½ĞµĞ²ÑƒÑ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
        cd code
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Gradle Wrapper ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚
        if [ ! -f "gradlew" ]; then
          echo "ğŸ“¦ Creating Gradle Wrapper..."
          gradle wrapper --gradle-version=${{ env.GRADLE_VERSION }}
          
          # Ğ”ĞµĞ»Ğ°ĞµĞ¼ gradlew Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼Ñ‹Ğ¼
          chmod +x gradlew
          echo "âœ… Gradle Wrapper created"
        else
          echo "âœ… Gradle Wrapper already exists"
          chmod +x gradlew
        fi
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ wrapper ÑĞ¾Ğ·Ğ´Ğ°Ğ»ÑÑ
        echo "ğŸ“‹ Checking Gradle Wrapper files:"
        ls -la gradlew* || echo "No gradlew files"
        ls -la gradle/wrapper/ || echo "No gradle/wrapper directory"
        
    - name: ğŸ“¦ Setup Gradle caching
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Check project structure
      run: |
        echo "ğŸ“ Project structure:"
        ls -lah
        echo ""
        echo "ğŸ” Searching for Gradle files:"
        find . -name "build.gradle" -o -name "build.gradle.kts" -o -name "gradlew" | head -20
        echo ""
        echo "ğŸ“Š Gradle version:"
        if [ -f "code/gradlew" ]; then
          cd code && ./gradlew --version || true
        else
          echo "âŒ gradlew not found in code directory"
        fi
        
    - name: ğŸ—ï¸ Build and Publish Shared Modules
      run: |
        echo "ğŸš€ Building and publishing shared modules to Maven Local..."
        if [ -f "code/gradlew" ]; then
          cd code && ./gradlew publishAllShared --stacktrace --info --build-cache
          
          echo "ğŸ“¦ Verifying published modules:"
          ls -la ~/.m2/repository/com/connection/ || echo "No Maven local repository found"
        else
          echo "âŒ Cannot build - gradlew not found"
          exit 1
        fi
        
    - name: â³ Wait for services to be ready
      run: |
        echo "Waiting for services to be fully ready..."
        sleep 10
        
        echo "Checking PostgreSQL..."
        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ postgresql-client Ğ´Ğ»Ñ pg_isready
        sudo apt-get update && sudo apt-get install -y postgresql-client
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ PostgreSQL Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°Ğ¼Ğ¸
        pg_isready -h localhost -p 5434 -U test_user -d test_db || echo "PostgreSQL not ready yet"
        
        echo "All services should be ready now"
        
    - name: ğŸ§ª Run All Tests
      run: |
        echo "ğŸ§ª Running all tests with testAll task..."
        if [ -f "code/gradlew" ]; then
          cd code && ./gradlew allTest --continue --build-cache
        else
          echo "âŒ Cannot run tests - gradlew not found"
          exit 1
        fi
        
      continue-on-error: true
        
    - name: ğŸ“Š Generate Test Reports
      if: always()
      run: |
        echo "ğŸ“Š Generating test reports..."
        if [ -f "code/gradlew" ]; then
          cd code && ./gradlew generateCombinedAllureReport --no-daemon --build-cache
        else
          echo "âŒ Cannot generate reports - gradlew not found"
        fi
        
    - name: ğŸ’¾ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          **/build/test-results/
          **/build/reports/
        retention-days: 30
        
    - name: ğŸ“ˆ Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: |
          **/build/reports/allure-report/
          **/build/allure-results/
        retention-days: 30
        
    - name: ğŸ“‹ Upload Build Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: service-jars
        path: |
          **/service/*/build/libs/*.jar
          **/shared/*/build/libs/*.jar
        retention-days: 7

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
