name: Java CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  JAVA_VERSION: '21'
  GRADLE_VERSION: '8.7'
  POSTGRES_IMAGE: 'postgres:15'
  KAFKA_IMAGE: 'confluentinc/cp-kafka:7.4.0'
  ZOOKEEPER_IMAGE: 'confluentinc/cp-zookeeper:7.4.0'

jobs:
  # –û—Å–Ω–æ–≤–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  build-and-test:
    name: üèóÔ∏è Build and Test
    runs-on: ubuntu-latest
    
    services:
      # PostgreSQL –¥–ª—è —Ç–µ—Å—Ç–æ–≤
      postgres:
        image: ${{ env.POSTGRES_IMAGE }}
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5434:5432
          
      # Zookeeper –¥–ª—è Kafka
      zookeeper:
        image: ${{ env.ZOOKEEPER_IMAGE }}
        env:
          ZOOKEEPER_CLIENT_PORT: 2181
          ZOOKEEPER_TICK_TIME: 2000
        options: >-
          --health-cmd "echo 'ruok' | nc localhost 2181"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
        ports:
          - 2182:2181
          
      # Kafka Broker
      kafka:
        image: ${{ env.KAFKA_IMAGE }}
        depends_on:
          zookeeper:
            condition: service_healthy
        env:
          KAFKA_BROKER_ID: 1
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9093,PLAINTEXT_HOST://0.0.0.0:29093
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9093,PLAINTEXT_HOST://localhost:29093
          KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
          KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
          KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
        options: >-
          --health-cmd "kafka-topics --bootstrap-server localhost:9093 --list"
          --health-interval 20s
          --health-timeout 10s
          --health-retries 5
        ports:
          - 9093:9093
          - 29093:29093

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ‚òï Setup Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'gradle'
        
    - name: üêò Setup Gradle ${{ env.GRADLE_VERSION }}
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: ${{ env.GRADLE_VERSION }}
        
    - name: üîç Check project structure
      run: |
        echo "üìÅ Project structure:"
        find . -name "build.gradle" -type f | head -20
        echo ""
        echo "üìä Gradle projects:"
        ./gradlew projects --no-daemon || true
        
    - name: üèóÔ∏è Build and Publish Shared Modules
      run: |
        echo "üöÄ Building and publishing shared modules to Maven Local..."
        ./gradlew publishAllShared --no-daemon --stacktrace --info
        
        echo "üì¶ Verifying published modules:"
        ls -la ~/.m2/repository/com/connection/ || echo "No Maven local repository found"
        
    - name: ‚è≥ Wait for services to be ready
      run: |
        echo "‚è≥ Waiting for services to be fully ready..."
        sleep 30
        
        echo "üîç Checking PostgreSQL..."
        pg_isready -h localhost -p 5434 -U test_user || echo "PostgreSQL not ready yet"
        
        echo "üîç Checking Kafka..."
        docker exec ${{ job.services.kafka.id }} kafka-topics --bootstrap-server localhost:9093 --list || echo "Kafka not ready yet"
        
        echo "‚úÖ All services should be ready now"
        
    - name: üß™ Run All Tests
      run: |
        echo "üß™ Running all tests with testAll task..."
        ./gradlew testAll --no-daemon --stacktrace --info --continue
        
      continue-on-error: true  # –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏
      
    - name: üìä Generate Test Reports
      if: always()
      run: |
        echo "üìä Generating test reports..."
        ./gradlew generateCombinedAllureReport --no-daemon
        
    - name: üì¶ Build All Services
      if: always()
      run: |
        echo "üì¶ Building all service modules..."
        ./gradlew buildAll --no-daemon --parallel -x test
        
    - name: üéØ Check Test Results
      if: always()
      run: |
        echo "üéØ Test Results Summary:"
        find . -name "TEST-*.xml" -path "*/build/test-results/*" | head -5 | while read file; do
          echo "üìÑ Test file: $file"
          if command -v xmllint >/dev/null 2>&1; then
            failures=$(xmllint --xpath 'string(//testsuite/@failures)' "$file" 2>/dev/null || echo "N/A")
            errors=$(xmllint --xpath 'string(//testsuite/@errors)' "$file" 2>/dev/null || echo "N/A")
            tests=$(xmllint --xpath 'string(//testsuite/@tests)' "$file" 2>/dev/null || echo "N/A")
            echo "   Tests: $tests, Failures: $failures, Errors: $errors"
          fi
        done
        
    - name: üíæ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          **/build/test-results/
          **/build/reports/
          **/allure-history/
        retention-days: 30
        
    - name: üìà Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: |
          build/reports/allure-report/
          build/allure-results/
        retention-days: 30
        
    - name: üìã Upload Build Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: service-jars
        path: |
          service/*/build/libs/*.jar
          shared/*/build/libs/*.jar
        retention-days: 7

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
  quality-check:
    name: üîç Quality Check
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: ‚òï Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'gradle'
        
    - name: üêò Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: ${{ env.GRADLE_VERSION }}
        
    - name: üìù Checkstyle Analysis
      run: |
        echo "üìù Running Checkstyle..."
        # –î–æ–±–∞–≤—å—Ç–µ checkstyle –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        # ./gradlew checkstyleMain checkstyleTest --no-daemon
        
    - name: üìä Dependency Check
      run: |
        echo "üìä Checking dependencies..."
        ./gradlew dependencies --no-daemon --configuration implementation | head -50
        
    - name: üîí Security Scan
      run: |
        echo "üîí Basic security checks..."
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        if grep -r "password\|secret\|key" --include="*.java" --include="*.yml" --include="*.yaml" --include="*.properties" . | grep -v "test" | grep -v "//"; then
          echo "‚ö†Ô∏è  Possible sensitive data found in code"
        else
          echo "‚úÖ No obvious sensitive data found"
        fi

  # –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏)
  docker-build:
    name: üê≥ Build Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    
    strategy:
      matrix:
        service: [
          'auth-service', 
          'buffer-service', 
          'connection-scheme-service',
          'device-service',
          'device-auth-service', 
          'message-service'
        ]
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: üì¶ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: service-jars
        path: artifacts/
        
    - name: üîç Check Artifacts
      run: |
        echo "üì¶ Downloaded artifacts:"
        find artifacts/ -name "*.jar" -type f | head -10
        
    - name: üê≥ Build Docker Images
      run: |
        for service in ${{ join(matrix.service, ' ') }}; do
          echo "üê≥ Building Docker image for $service"
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π Dockerfile –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if [ ! -f "service/$service/Dockerfile" ]; then
            cat > "service/$service/Dockerfile" << EOF
FROM eclipse-temurin:21-jre
WORKDIR /app
COPY artifacts/service/$service/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
EOF
            echo "üìÑ Created temporary Dockerfile for $service"
          fi
          
          # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
          docker build -t $service:latest ./service/$service/
          docker images | grep $service
        done
        
    - name: üß™ Test Docker Images
      run: |
        for service in ${{ join(matrix.service, ' ') }}; do
          echo "üß™ Testing $service image..."
          docker run --rm $service:latest --version || echo "‚úÖ $service image built successfully"
        done

  # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (–∑–∞–≥–æ—Ç–æ–≤–∫–∞)
  deploy:
    name: üöÄ Deploy
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üéØ Deployment Preparation
      run: |
        echo "üöÄ Preparing for deployment..."
        echo "üìã Services to deploy:"
        echo "  - auth-service"
        echo "  - buffer-service" 
        echo "  - connection-scheme-service"
        echo "  - device-service"
        echo "  - device-auth-service"
        echo "  - message-service"
        
        # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
        # –ù–∞–ø—Ä–∏–º–µ—Ä, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
        # –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –æ–±–ª–∞—á–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
        
    - name: üìä Create Deployment Summary
      if: always()
      run: |
        echo "## üéâ CI/CD Pipeline Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìä Build Results" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Shared modules published to Maven Local" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ All tests executed" >> $GITHUB_STEP_SUMMARY  
        echo "- ‚úÖ Services built successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üê≥ Docker Images" >> $GITHUB_STEP_SUMMARY
        echo "- Built images for all services" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîó Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Test reports available as artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Allure reports generated" >> $GITHUB_STEP_SUMMARY

  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  notify:
    name: üì¢ Notify
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy]
    if: always()
    
    steps:
    - name: üìä Pipeline Status
      run: |
        if [ "${{ needs.build-and-test.result }}" == "success" ]; then
          echo "‚úÖ Pipeline completed successfully!"
        else
          echo "‚ùå Pipeline failed in build-and-test job"
          exit 1
        fi

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
