server {
    listen 80;
    server_name localhost;
    
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Корень для статики
    root /usr/share/nginx/static;
    index index.html;

    # Главная страница
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Management page - исправленная версия
    location = /management {
        try_files /management.html =404;
    }

    location = /management/ {
        return 302 /management;
    }

    # Reserved
    location /reserved/ {
        try_files $uri $uri/ /index.html;
    }

    # API v1 - Swagger UI
    location = /api/v1 {
        return 302 /api/v1/;
    }

    location = /api/v1/ {
        return 302 /swagger-ui/index.html?url=/v3/api-docs/v1;
    }

    # API endpoints (все остальные пути под /api/v1/)
    location /api/v1/ {
        # Если запрос именно к корню /api/v1/ - перенаправляем на Swagger
        location = /api/v1/ {
            return 302 /swagger-ui/index.html?url=/v3/api-docs/v1;
        }
        
        # Все остальные пути под /api/v1/ проксируем к API
        proxy_pass http://gateway-service:8080/api/v1/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Swagger UI - основной путь
    location /swagger-ui/ {
        proxy_pass http://gateway-service:8080/swagger-ui/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Переписываем URL в контенте
        sub_filter '="/swagger-ui/' '="/swagger-ui/';
        sub_filter 'href="/' 'href="/swagger-ui/';
        sub_filter 'src="/' 'src="/swagger-ui/';
        sub_filter 'url="/' 'url="/swagger-ui/';
        sub_filter_once off;
        sub_filter_types text/html text/css application/javascript;
    }

    # Swagger API документация
    location /v3/api-docs/ {
        proxy_pass http://gateway-service:8080/v3/api-docs/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
    }

    # Webjars (статические ресурсы Swagger)
    location /webjars/ {
        proxy_pass http://gateway-service:8080/webjars/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
    }

    # Короткие пути для Swagger
    location = /swagger {
        return 302 /swagger-ui/index.html;
    }

    location = /api-docs/v1 {
        return 302 /v3/api-docs/v1;
    }

    # Legacy - на Swagger
    location = /legacy {
        return 302 /swagger-ui/index.html;
    }

    # docs with markdown rendering
    location /documentation {
        # HTML версия с рендерингом markdown
        try_files /markdown-template.html =404;
        default_type text/html;
        add_header Content-Type "text/html; charset=utf-8";
    }

    location /documentation/raw {
        # Raw markdown файл
        alias /usr/share/nginx/documentation/README.md;
        default_type text/plain;
        add_header Content-Type "text/plain; charset=utf-8";
        add_header Access-Control-Allow-Origin "*";
    }

    # Статические файлы для документации
    location /static/documentation/ {
        alias /usr/share/nginx/documentation/;
        expires 1h;
        add_header Cache-Control "public";
    }

    # Status - простая текстовая версия
    location /status {
        stub_status on;
        access_log off;
        allow all;
    }

    # Status pretty - HTML страница
    location = /status/pretty {
        try_files /status.html =404;
        default_type text/html;
        add_header Content-Type "text/html; charset=utf-8";
    }

    # Статические файлы
    location /static/ {
        alias /usr/share/nginx/static/;
        expires 1h;
        add_header Cache-Control "public";
    }

    location /admin/ {
        proxy_pass http://pgadmin:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Script-Name /admin;
        
        # Переписываем пути в HTML
        sub_filter 'href="/' 'href="/admin/';
        sub_filter 'src="/' 'src="/admin/';
        sub_filter 'action="/' 'action="/admin/';
        sub_filter_once off;
        sub_filter_types text/html text/css application/javascript;
    }

    # Обработка ошибок
    error_page 404 /static/404.html;
    error_page 500 502 503 504 /static/50x.html;
}