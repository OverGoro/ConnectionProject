plugins {
    id 'java'
    id 'io.spring.dependency-management' version '1.1.7'
    id 'io.qameta.allure' version '3.0.0'
    id 'maven-publish'
    id 'com.dorongold.task-tree' version '2.1.1'
}

// ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ü–†–û–ï–ö–¢–ê ==========
allprojects {
    group = 'com.connection'
    version = '1.0.0'
    
    apply plugin: 'java'
    apply plugin: 'io.spring.dependency-management'
    apply plugin: 'maven-publish'
    
    java {
        toolchain {
            languageVersion = JavaLanguageVersion.of(21)
        }
    }
    
    configurations {
        compileOnly {
            extendsFrom annotationProcessor
        }
    }
    
    repositories {
        mavenCentral()
        mavenLocal()
    }
    
    dependencyManagement {
        imports {
            mavenBom "org.springframework.boot:spring-boot-dependencies:3.5.5"
        }
    }
}

// ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –î–õ–Ø –ü–û–î–ü–†–û–ï–ö–¢–û–í ==========
subprojects {
    // –û–±—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
    dependencies {
        compileOnly 'org.projectlombok:lombok:1.18.38'
        annotationProcessor 'org.projectlombok:lombok:1.18.38'
        
        testImplementation 'org.junit.jupiter:junit-jupiter:5.12.2'
        testImplementation 'org.mockito:mockito-core:5.18.0'
        testImplementation 'org.mockito:mockito-junit-jupiter:5.18.0'
        testImplementation 'org.assertj:assertj-core:3.27.3'
        testImplementation 'io.qameta.allure:allure-junit5:2.29.1'
        testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
    }
    
    tasks.withType(JavaCompile).configureEach {
        options.compilerArgs += ['-parameters']
        options.encoding = 'UTF-8'
    }
    
    test {
        useJUnitPlatform()
        testLogging {
            events "passed", "skipped", "failed"
            exceptionFormat "full"
        }
    }
}

// ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ALLURE –î–õ–Ø –í–°–ï–ì–û –ü–†–û–ï–ö–¢–ê ==========
ext {
    ALLURE_RESULTS_DIR = "${buildDir}/allure-results"
    ALLURE_REPORT_DIR = "${buildDir}/reports/allure-report"
    ALLURE_HISTORY_DIR = "${projectDir}/allure-history"
}

allure {
    version = "2.29.0"
    adapter {
        frameworks {
            junit5 {
                enabled = true
            }
        }
    }
}

// ========== –ó–ê–î–ê–ß–ò –î–õ–Ø –í–°–ï–ì–û –ü–†–û–ï–ö–¢–ê ==========

// –°–±–æ—Ä–∫–∞ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
task buildAll {
    description = 'Build all modules'
    group = 'Build'
    dependsOn subprojects.build
}

// –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
task testAll {
    description = 'Run tests in all modules'
    group = 'Verification'
}

// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –æ—Ü–µ–Ω–∫–∏ –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
gradle.projectsEvaluated {
    subprojects { project ->
        def allTestsTask = project.tasks.findByName('allTests')
        if (allTestsTask) {
            testAll.dependsOn allTestsTask
            logger.lifecycle("‚úÖ Adding allTests dependency from: ${project.name}")
        } else {
            logger.lifecycle("‚ùå No allTests task found in: ${project.name}")
        }
    }
}

// –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
task cleanAll {
    description = 'Clean all modules'
    group = 'Build'
    dependsOn subprojects.clean
}

// –°–±–æ—Ä–∫–∞ –æ—Ç—á–µ—Ç–æ–≤ Allure –∏–∑ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
task collectAllureResults {
    description = 'Collect Allure results from all modules'
    group = 'Reporting'
    
    doFirst {
        file(ALLURE_RESULTS_DIR).mkdirs()
        
        // –ö–æ–ø–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ –≤—Å–µ—Ö –ø–æ–¥–ø—Ä–æ–µ–∫—Ç–æ–≤
        subprojects.each { subproject ->
            def subprojectResults = "${subproject.buildDir}/allure-results"
            def subprojectDir = file(subprojectResults)
            
            if (subprojectDir.exists()) {
                logger.lifecycle("üìÅ Copying results from: ${subproject.name}")
                copy {
                    from subprojectDir
                    into ALLURE_RESULTS_DIR
                }
            }
        }
    }
}

task generateCombinedAllureReport(type: Exec) {
    description = 'Generate combined Allure report from all modules'
    group = 'Reporting'
    
    dependsOn collectAllureResults
    
    doFirst {
        logger.lifecycle("üìä Generating combined Allure report...")
        file(ALLURE_REPORT_DIR).mkdirs()
    }
    
    commandLine 'allure', 'generate', "${ALLURE_RESULTS_DIR}", '-o', "${ALLURE_REPORT_DIR}", '--clean'
    
    doLast {
        def reportFile = file("${ALLURE_REPORT_DIR}/index.html")
        if (reportFile.exists()) {
            logger.lifecycle("‚úÖ Combined Allure report generated at: ${ALLURE_REPORT_DIR}")
            logger.lifecycle("   Open: file://${reportFile.absolutePath}")
        }
    }
}

task serveCombinedAllureReport(type: Exec) {
    description = 'Serve combined Allure report'
    group = 'Reporting'
    
    dependsOn generateCombinedAllureReport
    
    commandLine 'allure', 'serve', "${ALLURE_RESULTS_DIR}"
}

// –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤—Å–µ—Ö shared –º–æ–¥—É–ª–µ–π
task publishAllShared {
    description = 'Publish all shared modules to local Maven'
    group = 'Publishing'
    dependsOn subprojects.findAll { it.path.contains('shared') && it.tasks.findByName('publish') }.publish
}

// ========== –ó–ê–î–ê–ß–ò –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ ==========
defaultTasks 'buildAll'